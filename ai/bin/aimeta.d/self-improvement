#!/usr/bin/env bash
### DESCRIPTION: Capture agent corrections and feedback for learning and improvement

set -euo pipefail

SCRIPT_NAME="aimeta self-improvement"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SUBCOMMAND_DIR="${SCRIPT_DIR}/self-improvement.d"
DATA_DIR="${HOME}/.local/shared/aimeta/self-improvement"
ENTRIES_DIR="${DATA_DIR}/entries"
INDEX_FILE="${DATA_DIR}/index.json"

# Colors for output
if [[ -t 1 ]]; then
  BOLD='\033[1m'
  GREEN='\033[32m'
  YELLOW='\033[33m'
  RED='\033[31m'
  CYAN='\033[36m'
  RESET='\033[0m'
else
  BOLD=''
  GREEN=''
  YELLOW=''
  RED=''
  CYAN=''
  RESET=''
fi

# Valid agent types
VALID_AGENTS=("task-worker" "janitor" "leader" "orchestrator" "code-review" "safety-check" "general")

# Valid categories
VALID_CATEGORIES=("file-operations" "git" "safety" "code-quality" "workflow" "performance" "documentation" "testing" "integration" "other")

# Valid severity levels
VALID_SEVERITY=("high" "medium" "low")

# Initialize storage
init_storage() {
  mkdir -p "$ENTRIES_DIR"
  if [[ ! -f "$INDEX_FILE" ]]; then
    echo '[]' > "$INDEX_FILE"
  fi
}

# Show help message
usage() {
  echo "${SCRIPT_NAME} - Capture agent corrections and feedback for learning and improvement"
  echo ""
  echo "USAGE:"
  echo "  ${SCRIPT_NAME} <subcommand> [options]"
  echo ""
  echo "SUBCOMMANDS:"
  echo "  add              Add a new feedback entry"
  echo "  list             View and filter feedback entries"
  echo "  show <id>        Display detailed entry"
  echo "  review-session   Batch review feedback entries"
  echo "  export           Export feedback for skill creation"
  echo "  stats            Show statistics and insights"
  echo "  clean            Archive or delete old feedback"
  echo "  link-skill <id>  Link feedback to a skill"
  echo "  help             Show this help message"
}

# Source shared utilities
source "${SUBCOMMAND_DIR}/lib/utils.sh"

# Parse subcommand
subcommand="${1:-help}"

case "$subcommand" in
  add)
    shift
    source "${SUBCOMMAND_DIR}/commands/add.sh"
    cmd_add "$@"
    ;;
  list)
    shift
    source "${SUBCOMMAND_DIR}/commands/list.sh"
    cmd_list "$@"
    ;;
  show)
    shift
    source "${SUBCOMMAND_DIR}/commands/show.sh"
    cmd_show "$@"
    ;;
  review-session)
    shift
    source "${SUBCOMMAND_DIR}/commands/review.sh"
    cmd_review_session "$@"
    ;;
  export)
    shift
    source "${SUBCOMMAND_DIR}/commands/export.sh"
    cmd_export "$@"
    ;;
  stats)
    shift
    source "${SUBCOMMAND_DIR}/commands/stats.sh"
    cmd_stats "$@"
    ;;
  clean)
    shift
    source "${SUBCOMMAND_DIR}/commands/clean.sh"
    cmd_clean "$@"
    ;;
  link-skill)
    shift
    source "${SUBCOMMAND_DIR}/commands/link.sh"
    cmd_link_skill "$@"
    ;;
  help|--help|-h)
    usage
    exit 0
    ;;
  --help-for-agents)
    echo "aimeta self-improvement - Agent Guide"
    exit 0
    ;;
  *)
    echo "Error: Unknown subcommand '$subcommand'" >&2
    usage >&2
    exit 1
    ;;
esac
