#!/usr/bin/env bash
### DESCRIPTION: List subagents available for the current agent and their descriptions

set -euo pipefail

SCRIPT_NAME="aimeta subagents"
AGENTS_DIR="${HOME}/.dotfiles/ai/shared/agents"

# Colors for output (disabled if not a terminal)
if [[ -t 1 ]]; then
  BOLD='\033[1m'
  RESET='\033[0m'
else
  BOLD=''
  RESET=''
fi

usage() {
  cat <<EOF
${SCRIPT_NAME} - List available subagents and their descriptions

USAGE:
  ${SCRIPT_NAME} [options]

OPTIONS:
  --help, -h    Show this help message

DESCRIPTION:
  Reads markdown files from the agents directory and extracts
  name and description from YAML frontmatter.

EXAMPLES:
  ${SCRIPT_NAME}
EOF
}

# Parse YAML frontmatter from a markdown file
# Extracts name, description, and mode fields
# Only outputs if mode is "subagent"
parse_agent_file() {
  local file="$1"
  local name=""
  local description=""
  local mode=""
  local in_frontmatter=false
  local frontmatter_count=0

  while IFS= read -r line; do
    # Detect frontmatter boundaries (---)
    if [[ "$line" == "---" ]]; then
      frontmatter_count=$((frontmatter_count + 1))
      if [[ $frontmatter_count -eq 1 ]]; then
        in_frontmatter=true
        continue
      elif [[ $frontmatter_count -eq 2 ]]; then
        break
      fi
    fi

    if [[ "$in_frontmatter" == true ]]; then
      # Extract name field
      if [[ "$line" =~ ^name:[[:space:]]*(.+)$ ]]; then
        name="${BASH_REMATCH[1]}"
      fi
      # Extract description field (single line)
      if [[ "$line" =~ ^description:[[:space:]]*(.+)$ ]]; then
        description="${BASH_REMATCH[1]}"
      fi
      # Extract mode field
      if [[ "$line" =~ ^mode:[[:space:]]*(.+)$ ]]; then
        mode="${BASH_REMATCH[1]}"
      fi
    fi
  done < "$file"

  # Output only if name and description were found AND mode is "subagent"
  if [[ -n "$name" && -n "$description" && "$mode" == "subagent" ]]; then
    printf "%s\t%s\n" "$name" "$description"
  fi
}

# Truncate description to fit terminal width
truncate_description() {
  local desc="$1"
  local max_len="$2"

  if [[ ${#desc} -gt $max_len ]]; then
    echo "${desc:0:$((max_len - 3))}..."
  else
    echo "$desc"
  fi
}

cmd_subagents() {
  if [[ ! -d "$AGENTS_DIR" ]]; then
    echo "Error: Agents directory not found: $AGENTS_DIR" >&2
    exit 1
  fi

  # Find all markdown files in agents directory
  local agent_files
  agent_files=$(find "$AGENTS_DIR" -maxdepth 1 -name "*.md" -type f 2>/dev/null | sort)

  if [[ -z "$agent_files" ]]; then
    echo "No agents found in $AGENTS_DIR"
    exit 0
  fi

  # Collect agent data
  local agents=()
  local max_name_len=0

  while IFS= read -r file; do
    local data
    data=$(parse_agent_file "$file")
    if [[ -n "$data" ]]; then
      agents+=("$data")
      local name
      name=$(echo "$data" | cut -f1)
      if [[ ${#name} -gt $max_name_len ]]; then
        max_name_len=${#name}
      fi
    fi
  done <<< "$agent_files"

  if [[ ${#agents[@]} -eq 0 ]]; then
    echo "No valid agents found (missing name or description in frontmatter)"
    exit 0
  fi

  echo -e "${BOLD}Available subagents:${RESET}"

  # Sort agents by name and display (full description)
  printf '%s\n' "${agents[@]}" | sort | while IFS=$'\t' read -r name description; do
    printf "  %-${max_name_len}s - %s\n" "$name" "$description"
  done
}

# Main
main() {
  case "${1:-}" in
    --help|-h)
      usage
      exit 0
      ;;
  esac

  cmd_subagents
}

main "$@"
